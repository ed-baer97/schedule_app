# Условия составления расписания

## 1. ОБЯЗАТЕЛЬНЫЕ ОГРАНИЧЕНИЯ (Hard Constraints)

### 1.1. Ограничения учителей
- **Учитель не может быть в двух классах одновременно** в один и тот же слот (день, урок)
- **Исключение для подгрупп**: В одном слоте для одного класса может быть несколько учителей, если:
  - Это один и тот же предмет (`subject_id` одинаковый)
  - Учитель еще не добавлен в эту подгруппу
- Учитель не может быть дважды в одном слоте для одного класса с одним предметом

### 1.2. Ограничения кабинетов
- **Кабинет не может быть занят более чем `max_classes_simultaneously` классами одновременно**
  - По умолчанию: `max_classes_simultaneously = 1`
  - Если `max_classes_simultaneously > 1`, в кабинете могут быть несколько классов одновременно
- **Кабинет с `subgroups_only = True`**:
  - Может использоваться только для подгрупп
  - Подгруппа = несколько уроков с одинаковым `subject_id` в одном слоте для одного класса
- **Кабинет с `exclusive_to_subject = True` или `subject_id != None`**:
  - Может использоваться только для предмета, к которому привязан
  - Если `cabinet.subject_id != subject_id` → нельзя использовать

### 1.3. Ограничения классов
- **Максимум уроков в день для класса**: не более `max_lessons_per_day[day]`
  - По умолчанию: 6 уроков в день
  - Настраивается для каждого дня недели отдельно
- **В одном слоте для класса**:
  - Могут быть только уроки с одинаковым предметом (подгруппы)
  - Нельзя разместить разные предметы в одном слоте

### 1.4. Ограничения по часам
- Должно быть размещено **точно `total_hours_per_week`** часов для каждой пары (класс, предмет)
- Если не удалось разместить все часы → расписание считается неполным

### 1.5. Ограничения по сменам
- Алгоритм работает **только с классами выбранной смены**
- Классы должны быть явно назначены смене через модель `ShiftClass`

---

## 2. ПРИОРИТЕТЫ РАЗМЕЩЕНИЯ (Soft Constraints / Heuristics)

### 2.1. Приоритет размещения задач (порядок обработки)

**Эвристика 1: Сортировка задач по сложности**
1. **Подгруппы размещаются первыми** (они сложнее)
2. **Больше часов = выше приоритет** (сначала размещаем предметы с большим количеством часов)
3. **Больше учителей = сложнее** (предметы с несколькими учителями размещаются раньше)
4. На каждой новой попытке порядок немного меняется (для разнообразия комбинаций)

### 2.2. Приоритет кабинетов

**Порядок выбора кабинетов для учителя:**

1. **Приоритет 1 (высший)**: Кабинеты, закрепленные за учителем (`CabinetTeacher`)
   - Учитель назначен на этот кабинет
   - Кабинет соответствует предмету и ограничениям

2. **Приоритет 2 (средний)**: Кабинеты для этого предмета, но не закрепленные за учителем
   - Кабинет привязан к предмету (`subject_id`)
   - Не закреплен за учителем

3. **Приоритет 3 (низкий)**: Другие кабинеты
   - Не привязаны к предмету
   - Не имеют ограничения `exclusive_to_subject`

**Дополнительные приоритеты для кабинетов с `max_classes_simultaneously > 1`:**
- Если в кабинете уже есть классы той же параллели → **приоритет 0** (самый высокий)
- Если есть место, но другой параллели → **приоритет 1.5** (средний)

### 2.3. Приоритет слотов (день, урок)

**Эвристика 2: Равномерное распределение**
- Предпочтение отдается дням с **меньшим количеством уже размещенных уроков** для этого класса
- Базовый приоритет: `base_priority = day_lesson_counts[day]` (меньше = лучше)

**Эвристика 3: Группировка параллелей**
- Для учителя: **классы одной параллели стараются размещать в один день**
- Если в день уже есть классы той же параллели у учителя → **приоритет -100** (высокий)
- Если в день есть другие параллели → **приоритет +50** (низкий)

**Эвристика 4: Заполнение окон (самый важный приоритет)**
- **Заполнение окна между уроками**: приоритет **-1000** (самый высокий)
  - Условие: есть уроки до и после текущего урока
- **Размещение рядом с существующими уроками** (без создания окна): приоритет **-200**
- **Размещение, которое создаст окно**: приоритет **+100** (низкий, избегаем)

**Эвристика 5: Распределение категорий предметов (мягкое ограничение)**
- **Максимум 3 предмета одной категории в день для класса** (мягкое ограничение)
  - Если в день уже 3+ предмета категории → день пропускается при размещении
  - В CP-SAT добавляется штраф за превышение лимита
- **Равномерное распределение категорий по дням**
  - Приоритет: дни без предметов этой категории получают приоритет **-100**
  - Дни с 2+ предметами категории получают приоритет **+100**
  - Дни с 1 предметом категории получают приоритет **+10**
- **Категории предметов**: `languages`, `humanities`, `natural_math`

### 2.4. Приоритет при выборе лучшего варианта

После генерации нескольких вариантов (до 5 попыток):
1. **Сначала выбираются варианты БЕЗ окон в классах**
2. Если таких нет → выбирается вариант с минимальным количеством окон
3. Оценка варианта:
   - Если есть окна в классах: `score = 1000000 + class_windows * 10000 + teacher_windows` (очень плохо)
   - Если нет окон в классах: `score = teacher_windows` (только окна у учителей)

---

## 3. ПОСТОБРАБОТКА

### 3.1. Устранение окон в классах
- Функция `_eliminate_windows()` вызывается после размещения всех уроков
- Работает итеративно (до 50 попыток) до полного устранения окон
- Пытается переместить уроки между днями для заполнения окон
- Пытается менять уроки местами между классами, если это помогает

### 3.2. Повторное устранение окон
- После размещения всех уроков функция вызывается до 3 раз
- Если количество окон не уменьшается → прекращает попытки

---

## 4. ОСОБЫЕ СЛУЧАИ

### 4.1. Подгруппы
- **Определение**: Несколько учителей для одного предмета в одном классе
- **Размещение**: Все учителя подгруппы размещаются в один слот (день, урок)
- **Ограничения**:
  - Каждый учитель должен иметь доступный кабинет
  - Кабинет с `subgroups_only = True` может использоваться только для подгрупп
- **Приоритет**: Подгруппы размещаются первыми (они сложнее)

### 4.2. Классы одной параллели
- **Определение**: Классы с одинаковой параллелью (например, "5А", "5Б", "5В" → параллель "5")
- **Группировка для учителя**: Классы одной параллели стараются размещать в один день
- **Группировка в кабинете**: Если `max_classes_simultaneously > 1`, приоритет отдается классам одной параллели

### 4.3. Кабинеты с несколькими классами
- Если `max_classes_simultaneously > 1`:
  - В кабинете могут быть несколько классов одновременно
  - Приоритет: размещать классы одной параллели
  - Если есть место, можно разместить классы другой параллели (но с меньшим приоритетом)

---

## 5. ПАРАМЕТРЫ АЛГОРИТМА

### 5.1. Параметры решения
- `max_iterations = 10000` - максимальное количество итераций внутри одной попытки
- `max_attempts = 5` - максимальное количество попыток размещения всех уроков

### 5.2. Параметры устранения окон
- `max_iterations = 50` - максимальное количество итераций для устранения окон
- Повторное устранение: до 3 раз

### 5.3. Учебные дни
- По умолчанию: `[1, 2, 3, 4, 5]` (понедельник - пятница)
- Настраивается через параметр `study_days`

---

## 6. КРИТЕРИИ УСПЕХА

### 6.1. Успешное расписание
- ✅ Все уроки размещены (`remaining_hours = 0` для всех требований)
- ✅ **Нет окон в классах** (обязательное требование)
- ✅ Минимальное количество окон у учителей
- ✅ Все ограничения соблюдены

### 6.2. Неуспешное расписание
- ❌ Не все уроки размещены
- ❌ Есть окна в классах (недопустимо)
- ❌ Нарушены обязательные ограничения

---

## 7. СООБЩЕНИЯ ОБ ОШИБКАХ

### 7.1. Детальные предупреждения
Если урок не удалось разместить, указывается:
- Класс и предмет
- Количество неразмещенных часов
- **Детальные причины**:
  - "нет свободных слотов"
  - "учитель занят"
  - "кабинет занят"
  - "превышен лимит уроков"
  - "нет назначенных учителей"
  - "конфликты при размещении"

### 7.2. Общие предупреждения
- Если после всех попыток не все уроки размещены → общее предупреждение с статистикой
- Показывается количество размещенных уроков из требуемых

---

## 8. СТРУКТУРЫ ДАННЫХ

### 8.1. Внутренние структуры отслеживания
- `teacher_busy`: `{(day, lesson, teacher_id): {class_ids}}` - занятость учителей
- `cabinet_busy`: `{(day, lesson, cabinet): {class_ids}}` - занятость кабинетов
- `class_lessons_count`: `{(class_id, subject_id): count}` - количество размещенных уроков
- `teacher_day_parallels`: `{(teacher_id, day): {parallel}}` - параллели классов у учителя в день
- `class_parallels`: `{class_id: parallel}` - параллель каждого класса

### 8.2. Информация о кабинетах
- `cabinet_info`: `{cabinet_name: {'subgroups_only': bool, 'exclusive_to_subject': bool, 'subject_id': int, 'max_classes_simultaneously': int}}`

---

## 9. ПОРЯДОК РАБОТЫ АЛГОРИТМА

1. **Инициализация**: Загрузка требований, существующего расписания, ограничений
2. **Генерация вариантов**: До 5 попыток с разным порядком задач
3. **Размещение уроков**:
   - Сортировка задач по сложности
   - Для каждой задачи: выбор лучшего слота и кабинета
   - Приоритет: заполнение окон → группировка параллелей → равномерное распределение
4. **Постобработка**: Устранение окон в классах (до 3 раз)
5. **Оценка**: Подсчет окон в классах и у учителей
6. **Выбор лучшего**: Выбор варианта без окон в классах (или с минимальным количеством)

---

## 10. МЯГКИЕ ОГРАНИЧЕНИЯ НА ОСНОВЕ КАТЕГОРИЙ ПРЕДМЕТОВ

### 10.1. Ограничения категорий

**Мягкое ограничение 1: Максимум предметов категории в день**
- Для каждого класса: максимум 3 предмета одной категории в день
- Если лимит превышен → день пропускается при размещении (greedy)
- В CP-SAT добавляется штраф в целевую функцию за превышение

**Мягкое ограничение 2: Равномерное распределение категорий**
- Предметы одной категории распределяются по разным дням недели
- Приоритет размещения: дни без категории > дни с 1 предметом > дни с 2+ предметами
- Это обеспечивает разнообразие категорий в течение недели

**Категории предметов:**
- `languages` - Языки (Русский, Казахский, Английский и т.д.)
- `humanities` - Гуманитарные предметы (История, Литература и т.д.)
- `natural_math` - Естественно-математические предметы (Математика, Физика, Химия и т.д.)

### 10.2. Реализация

- Категории передаются в алгоритм через параметр `subject_categories: Dict[int, str]`
- Используются в `greedy_placement()` для приоритизации дней
- Используются в `cp_sat_solve()` для штрафов в целевой функции
- Используются в `lns_improve()` для оптимизации (если переданы)

---

## 11. ИЗВЕСТНЫЕ ОГРАНИЧЕНИЯ

- Алгоритм не гарантирует оптимальное решение (эвристический подход)
- При большом количестве ограничений может не найти решение
- Окна у учителей допускаются (но минимизируются)
- Окна в классах недопустимы (алгоритм пытается их полностью устранить)
- Мягкие ограничения категорий могут быть нарушены, если нет других вариантов размещения

