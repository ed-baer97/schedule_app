{% extends "admin/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4" data-subject-id="{{ subject.id }}" data-subject-name="{{ subject.name }}" data-shift-id="{{ shift_id }}">
    <h2>{{ subject.name }}</h2>
    <div class="btn-group">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeacherModal">
            + Добавить учителя
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createTeacherModal">
            + Создать нового учителя
        </button>
    </div>
</div>

{% if teachers %}
<div class="list-group">
    {% for item in teachers_with_classes %}
    {% set teacher = item.teacher %}
    {% set classes = item.classes %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
        <div class="flex-grow-1">
            <h5 class="mb-1">{{ teacher.full_name }}</h5>
            <p class="mb-0 text-muted">
                <i class="bi bi-telephone"></i> 
                <span id="phone-{{ teacher.id }}">{{ teacher.phone or 'Не указан' }}</span>
            </p>
            <div class="mt-2">
                <small class="text-muted">
                    <i class="bi bi-mortarboard"></i> Классы: 
                    {% if classes %}
                        {% for cls in classes %}
                            <span class="badge bg-info me-1">{{ cls.name }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">Не назначены</span>
                    {% endif %}
                </small>
            </div>
        </div>
        <div class="btn-group ms-3">
            <button class="btn btn-info btn-sm manage-classes-btn" 
                    data-teacher-id="{{ teacher.id }}"
                    data-teacher-name="{{ teacher.full_name }}">
                <i class="bi bi-mortarboard"></i> Классы
            </button>
        <button class="btn btn-danger btn-sm remove-teacher-btn" 
                data-teacher-id="{{ teacher.id }}" 
                data-teacher-name="{{ teacher.full_name }}">
            <i class="bi bi-trash"></i> Удалить
    </button>
        </div>
</div>
            {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    <p class="mb-0">Нет учителей, назначенных на этот предмет.</p>
    <p class="mb-0">Нажмите кнопку "Добавить учителя" чтобы начать.</p>
</div>
{% endif %}

<!-- Модальное окно: добавить учителя -->
<div class="modal fade" id="addTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить учителя в предмет «{{ subject.name }}»</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select id="newTeacherSelect" class="form-select mb-3">
                    <option value="">— Выберите учителя —</option>
                    {% for t in all_teachers %}
                        <option value="{{ t.id }}" data-phone="{{ t.phone or '' }}">{{ t.full_name }}</option>
                    {% endfor %}
                </select>
                <div id="teacherPhoneInfo" class="text-muted mb-3" style="display: none;">
                    <small>Телефон: <span id="selectedTeacherPhone"></span></small>
                </div>
                <button class="btn btn-success w-100" id="addTeacherBtn" disabled>Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно: создать нового учителя -->
<div class="modal fade" id="createTeacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать нового учителя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTeacherForm">
                    <div class="mb-3">
                        <label for="teacherFullName" class="form-label">Полное имя *</label>
                        <input type="text" class="form-control" id="teacherFullName" required 
                               placeholder="Иванов Иван Иванович">
                    </div>
                    <div class="mb-3">
                        <label for="teacherPhone" class="form-label">Номер телефона</label>
                        <input type="tel" class="form-control" id="teacherPhone" 
                               placeholder="+7 (999) 123-45-67">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">Создать учителя</button>
                        <button type="button" class="btn btn-outline-primary" id="createAndAddBtn" style="display: none;">
                            Создать и добавить к предмету
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно: управление классами учителя -->
<div class="modal fade" id="manageClassesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление классами учителя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manageClassesTeacherId">
                <input type="hidden" id="manageClassesTeacherName">
                
                <div class="mb-3">
                    <label class="form-label">Учитель: <strong id="manageClassesTeacherNameDisplay"></strong></label>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Привязанные классы:</label>
                    <div id="teacherClassesList" class="p-2 border rounded">
                        <p class="text-muted mb-0">Загрузка...</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Выберите классы:</label>
                    <div id="allClassesList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted mb-0">Загрузка классов...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveTeacherClasses()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
// Получаем данные из data-атрибутов
const subjectContainer = document.querySelector('[data-subject-id]');
const subjectId = subjectContainer.getAttribute('data-subject-id');
const subjectName = subjectContainer.getAttribute('data-subject-name');

// Показываем телефон выбранного учителя
document.getElementById('newTeacherSelect').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const phoneInfo = document.getElementById('teacherPhoneInfo');
    const phoneSpan = document.getElementById('selectedTeacherPhone');
    const addBtn = document.getElementById('addTeacherBtn');
    
    if (this.value) {
        const phone = selectedOption.getAttribute('data-phone');
        phoneSpan.textContent = phone || 'Не указан';
        phoneInfo.style.display = 'block';
        addBtn.disabled = false;
    } else {
        phoneInfo.style.display = 'none';
        addBtn.disabled = true;
    }
});

// Добавление нового учителя в предмет
document.getElementById('addTeacherBtn').addEventListener('click', function() {
    const teacherId = document.getElementById('newTeacherSelect').value;
    if (!teacherId) return;

    const shiftId = document.querySelector('[data-shift-id]').getAttribute('data-shift-id');
    fetch('/admin/add_teacher_to_subject', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            teacher_id: teacherId,
            subject_id: subjectId,
            shift_id: parseInt(shiftId)
        })
    }).then(() => location.reload());
});

// Удаление учителя из предмета
document.querySelectorAll('.remove-teacher-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const teacherId = this.getAttribute('data-teacher-id');
        const teacherName = this.getAttribute('data-teacher-name');
        
        if (!confirm(`Вы уверены, что хотите удалить учителя "${teacherName}" из предмета "${subjectName}"?`)) {
            return;
        }

        const shiftId = document.querySelector('[data-shift-id]').getAttribute('data-shift-id');
        fetch('/admin/remove_teacher_from_subject', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            teacher_id: teacherId,
                subject_id: subjectId,
                shift_id: parseInt(shiftId)
        })
    })
    .then(r => r.json())
    .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ошибка при удалении: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении учителя');
        });
    });
});

// Создание нового учителя
let shouldAddToSubject = false;
const createAndAddBtn = document.getElementById('createAndAddBtn');
const createTeacherForm = document.getElementById('createTeacherForm');

// Показываем кнопку "Создать и добавить" когда модальное окно открывается
document.getElementById('createTeacherModal').addEventListener('show.bs.modal', function() {
    shouldAddToSubject = false;
    createAndAddBtn.style.display = 'block';
});

createAndAddBtn.addEventListener('click', function() {
    shouldAddToSubject = true;
    createTeacherForm.dispatchEvent(new Event('submit'));
});

createTeacherForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fullName = document.getElementById('teacherFullName').value.trim();
    const phone = document.getElementById('teacherPhone').value.trim();
    
    if (!fullName) {
        alert('Пожалуйста, введите полное имя учителя');
        return;
    }

    fetch('/admin/teachers/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            full_name: fullName,
            phone: phone || null
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (shouldAddToSubject && data.teacher_id) {
                // Создаем учителя и сразу добавляем к предмету
                return fetch('/admin/add_teacher_to_subject', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
                        teacher_id: data.teacher_id,
                        subject_id: subjectId
        })
    }).then(() => location.reload());
            } else {
                // Просто создаем учителя и обновляем страницу
                location.reload();
            }
        } else {
            alert('Ошибка при создании учителя: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при создании учителя');
    });
});

// Управление классами учителя
document.querySelectorAll('.manage-classes-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const teacherId = parseInt(this.getAttribute('data-teacher-id'));
        const teacherName = this.getAttribute('data-teacher-name');
        
        document.getElementById('manageClassesTeacherId').value = teacherId;
        document.getElementById('manageClassesTeacherName').value = teacherName;
        document.getElementById('manageClassesTeacherNameDisplay').textContent = teacherName;
        
        // Загружаем текущие классы учителя
        fetch(`/admin/teachers/${teacherId}/classes`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Обновляем список привязанных классов
                    const teacherClassesList = document.getElementById('teacherClassesList');
                    if (data.teacher_classes.length > 0) {
                        teacherClassesList.innerHTML = data.teacher_classes.map(c => 
                            `<span class="badge bg-primary me-2 mb-2">${c.name}</span>`
                        ).join('');
                    } else {
                        teacherClassesList.innerHTML = '<p class="text-muted mb-0">Нет привязанных классов</p>';
                    }
                    
                    // Заполняем список всех классов с чекбоксами
                    const allClassesList = document.getElementById('allClassesList');
                    if (data.all_classes && data.all_classes.length > 0) {
                        allClassesList.innerHTML = data.all_classes.map(c => {
                            const isChecked = data.teacher_classes.some(tc => tc.id === c.id);
                            return `
                                <div class="form-check">
                                    <input class="form-check-input class-checkbox" type="checkbox" 
                                           value="${c.id}" id="class-${c.id}" ${isChecked ? 'checked' : ''}>
                                    <label class="form-check-label" for="class-${c.id}">
                                        ${c.name}
                                    </label>
                                </div>
                            `;
                        }).join('');
                    } else {
                        allClassesList.innerHTML = '<p class="text-muted mb-0">Нет классов в базе данных</p>';
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('manageClassesModal'));
                    modal.show();
                } else {
                    alert('Ошибка при загрузке классов: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при загрузке классов учителя');
            });
    });
});

function saveTeacherClasses() {
    const teacherId = parseInt(document.getElementById('manageClassesTeacherId').value);
    const selectedClasses = Array.from(document.querySelectorAll('.class-checkbox:checked'))
        .map(cb => parseInt(cb.value));
    
    fetch(`/admin/teachers/${teacherId}/classes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            class_ids: selectedClasses
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('manageClassesModal')).hide();
            alert('Классы учителя успешно обновлены');
            location.reload();
        } else {
            alert('Ошибка при сохранении: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении классов учителя');
    });
}
</script>
{% endblock %}
