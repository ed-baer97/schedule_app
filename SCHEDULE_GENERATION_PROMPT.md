# Промпт для генерации расписания уроков

## Описание системы

Система автоматического составления расписания уроков для школ. Поддерживает ручное и автоматическое составление расписания с учетом строгих ограничений и настраиваемых фильтров.

---

## 1. СТРОГИЕ ОГРАНИЧЕНИЯ (Hard Constraints) - ОБЯЗАТЕЛЬНЫ К СОБЛЮДЕНИЮ

### 1.1. Ограничения учителей

**КРИТИЧЕСКИ ВАЖНО:**
- ❌ **Учитель НЕ МОЖЕТ быть в двух классах одновременно** в один и тот же слот (день недели + номер урока)
- ✅ **ИСКЛЮЧЕНИЕ для подгрупп**: В одном слоте для одного класса может быть несколько учителей, ЕСЛИ:
  - Это один и тот же предмет (`subject_id` одинаковый)
  - Учитель еще не добавлен в эту подгруппу
- ❌ Учитель не может быть дважды в одном слоте для одного класса с одним предметом

**Пример нарушения:**
```
Понедельник, урок 1:
- Класс 5А: Математика, Учитель Иванов
- Класс 5Б: Физика, Учитель Иванов  ❌ НАРУШЕНИЕ! Учитель не может быть в двух классах одновременно
```

**Пример правильного использования подгрупп:**
```
Понедельник, урок 3:
- Класс 5А: Информатика, Учитель Петров (подгруппа 1)
- Класс 5А: Информатика, Учитель Сидоров (подгруппа 2)  ✅ ПРАВИЛЬНО - один предмет, разные учителя
```

### 1.2. Ограничения кабинетов

**КРИТИЧЕСКИ ВАЖНО:**
- ❌ **Кабинет не может быть занят более чем `max_classes_simultaneously` классами одновременно**
  - По умолчанию: `max_classes_simultaneously = 1` (один класс в кабинете)
  - Если `max_classes_simultaneously > 1`, в кабинете могут быть несколько классов одновременно
- ❌ **Кабинет с `subgroups_only = True`**:
  - Может использоваться ТОЛЬКО для подгрупп
  - Подгруппа = несколько уроков с одинаковым `subject_id` в одном слоте для одного класса
- ❌ **Кабинет с `exclusive_to_subject = True` или `subject_id != None`**:
  - Может использоваться ТОЛЬКО для предмета, к которому привязан
  - Если `cabinet.subject_id != subject_id` → нельзя использовать

**Примеры:**
```
Кабинет "101" (max_classes_simultaneously = 1):
Понедельник, урок 2:
- Класс 5А: Математика, Кабинет 101  ✅
- Класс 5Б: Физика, Кабинет 101  ❌ НАРУШЕНИЕ! Кабинет уже занят

Кабинет "201" (max_classes_simultaneously = 2):
Понедельник, урок 2:
- Класс 5А: Математика, Кабинет 201  ✅
- Класс 5Б: Физика, Кабинет 201  ✅ ПРАВИЛЬНО - кабинет может вместить 2 класса
```

### 1.3. Ограничения классов

**КРИТИЧЕСКИ ВАЖНО:**
- ❌ **Максимум уроков в день для класса**: не более `max_lessons_per_day[day]`
  - По умолчанию: 6 уроков в день
  - Настраивается для каждого дня недели отдельно
- ❌ **В одном слоте для класса**:
  - Могут быть ТОЛЬКО уроки с одинаковым предметом (подгруппы)
  - НЕЛЬЗЯ разместить разные предметы в одном слоте

**Пример нарушения:**
```
Понедельник, урок 1, Класс 5А:
- Математика, Учитель Иванов  ✅
- Физика, Учитель Петров  ❌ НАРУШЕНИЕ! Разные предметы в одном слоте

Понедельник, урок 1, Класс 5А:
- Информатика, Учитель Сидоров (подгруппа 1)  ✅
- Информатика, Учитель Козлов (подгруппа 2)  ✅ ПРАВИЛЬНО - один предмет, подгруппы
```

### 1.4. Ограничения по часам

**КРИТИЧЕСКИ ВАЖНО:**
- ✅ Должно быть размещено **ТОЧНО `total_hours_per_week`** часов для каждой пары (класс, предмет)
- ❌ Если не удалось разместить все часы → расписание считается неполным

**Пример:**
```
Класс 5А, Математика: требуется 5 часов в неделю
Размещено: 3 урока  ❌ НЕПОЛНОЕ РАСПИСАНИЕ
Размещено: 5 уроков  ✅ ПРАВИЛЬНО
```

### 1.5. Ограничения по сменам

**КРИТИЧЕСКИ ВАЖНО:**
- ✅ Алгоритм работает **ТОЛЬКО с классами выбранной смены**
- ✅ Классы должны быть явно назначены смене через модель `ShiftClass`

---

## 2. ФИЛЬТРЫ ДЛЯ ГЕНЕРАЦИИ РАСПИСАНИЯ

### 2.1. Выбор алгоритма генерации

Доступные алгоритмы:

1. **Pipeline (Рекомендуется)** - Комбинированный алгоритм
   - Использует комбинацию алгоритмов для лучшего результата
   - Этапы: Greedy → Graph Coloring → Bipartite Matching → CP-SAT
   - Лучшее качество, средняя скорость

2. **Greedy** - Быстрый жадный алгоритм
   - Быстрый, но менее точный
   - Подходит для простых случаев

3. **CP-SAT** - Точный алгоритм оптимизации
   - Точный, но медленный
   - Использует constraint programming

4. **Basic** - Базовый алгоритм
   - Простой базовый алгоритм
   - Минимальные требования

### 2.2. Режим размещения уроков

**Опция 1: Размещать уроки парами (по умолчанию)**
- Два урока одного предмета размещаются подряд (например, урок 2 и урок 3)
- Предпочтительно для большинства случаев

**Опция 2: Строго один предмет в день**
- Не размещать два урока одного предмета в один день
- Распределение уроков равномерно по дням недели

**Пример:**
```
Режим "парами":
Понедельник: Математика (урок 2), Математика (урок 3)  ✅

Режим "строго один в день":
Понедельник: Математика (урок 2)  ✅
Вторник: Математика (урок 3)  ✅
Среда: Математика (урок 4)  ✅
```

### 2.3. Настройки подгрупп

**Определение подгруппы:**
- Несколько уроков одного предмета или разных предметов
- Размещаются в одной ячейке расписания (один слот: день + урок) для одного класса

**Настройка пар предметов для подгрупп:**
- Можно настроить пары предметов, которые могут быть размещены в одной ячейке
- Примеры:
  - "Информатика" + "Информатика" (1 и 2 подгруппы одного предмета)
  - "Информатика" + "Казахский язык" (разные предметы в одной ячейке)
  - "Казахский язык" + "Английский язык" (разные предметы в одной ячейке)

**Пример использования:**
```
Понедельник, урок 3, Класс 5А:
- Информатика, Учитель Петров (подгруппа 1)
- Информатика, Учитель Сидоров (подгруппа 2)  ✅ ПРАВИЛЬНО

Понедельник, урок 4, Класс 5Б:
- Информатика, Учитель Козлов (подгруппа 1)
- Казахский язык, Учитель Нурланова (подгруппа 2)  ✅ ПРАВИЛЬНО (если настроено в фильтре)
```

---

## 3. СТРУКТУРА БАЗЫ ДАННЫХ

### 3.1. Основные таблицы

#### Таблица `subjects` (Предметы)
```sql
CREATE TABLE subjects (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE
);
```

**Пример данных:**
```json
[
    {"id": 1, "name": "Математика"},
    {"id": 2, "name": "Русский язык"},
    {"id": 3, "name": "Информатика"},
    {"id": 4, "name": "Казахский язык"},
    {"id": 5, "name": "Английский язык"}
]
```

#### Таблица `classes` (Классы)
```sql
CREATE TABLE classes (
    id INTEGER PRIMARY KEY,
    name VARCHAR(10) NOT NULL UNIQUE
);
```

**Пример данных:**
```json
[
    {"id": 1, "name": "5А"},
    {"id": 2, "name": "5Б"},
    {"id": 3, "name": "6А"},
    {"id": 4, "name": "6Б"}
]
```

#### Таблица `teachers` (Учителя)
```sql
CREATE TABLE teachers (
    id INTEGER PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    short_name VARCHAR(30),
    phone VARCHAR(20),
    telegram_id VARCHAR(50)
);
```

**Пример данных:**
```json
[
    {"id": 1, "full_name": "Иванов Иван Иванович", "short_name": "И.И.Иванов", "phone": "+77001234567", "telegram_id": "123456789"},
    {"id": 2, "full_name": "Петрова Мария Сергеевна", "short_name": "П.М.Петрова", "phone": "+77001234568", "telegram_id": null}
]
```

#### Таблица `shifts` (Смены)
```sql
CREATE TABLE shifts (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE
);
```

**Пример данных:**
```json
[
    {"id": 1, "name": "Первая смена", "is_active": true},
    {"id": 2, "name": "Вторая смена", "is_active": false}
]
```

#### Таблица `shift_classes` (Связь классов со сменами)
```sql
CREATE TABLE shift_classes (
    id INTEGER PRIMARY KEY,
    shift_id INTEGER NOT NULL REFERENCES shifts(id),
    class_id INTEGER NOT NULL REFERENCES classes(id),
    UNIQUE(shift_id, class_id)
);
```

**Пример данных:**
```json
[
    {"id": 1, "shift_id": 1, "class_id": 1},  // Класс 5А в первой смене
    {"id": 2, "shift_id": 1, "class_id": 2},  // Класс 5Б в первой смене
    {"id": 3, "shift_id": 2, "class_id": 3}   // Класс 6А во второй смене
]
```

#### Таблица `class_load` (Нагрузка классов по предметам)
```sql
CREATE TABLE class_load (
    id INTEGER PRIMARY KEY,
    shift_id INTEGER NOT NULL REFERENCES shifts(id),
    class_id INTEGER NOT NULL REFERENCES classes(id),
    subject_id INTEGER NOT NULL REFERENCES subjects(id),
    hours_per_week INTEGER NOT NULL,
    UNIQUE(shift_id, class_id, subject_id)
);
```

**Пример данных:**
```json
[
    {"id": 1, "shift_id": 1, "class_id": 1, "subject_id": 1, "hours_per_week": 5},  // 5А, Математика, 5 часов
    {"id": 2, "shift_id": 1, "class_id": 1, "subject_id": 2, "hours_per_week": 4},  // 5А, Русский язык, 4 часа
    {"id": 3, "shift_id": 1, "class_id": 1, "subject_id": 3, "hours_per_week": 2}  // 5А, Информатика, 2 часа (подгруппы)
]
```

#### Таблица `teacher_assignments` (Назначения учителей)
```sql
CREATE TABLE teacher_assignments (
    id INTEGER PRIMARY KEY,
    shift_id INTEGER NOT NULL REFERENCES shifts(id),
    teacher_id INTEGER NOT NULL REFERENCES teachers(id),
    subject_id INTEGER NOT NULL REFERENCES subjects(id),
    class_id INTEGER NOT NULL REFERENCES classes(id),
    hours_per_week INTEGER DEFAULT 0,
    default_cabinet VARCHAR(10),
    UNIQUE(shift_id, teacher_id, subject_id, class_id)
);
```

**Пример данных:**
```json
[
    {"id": 1, "shift_id": 1, "teacher_id": 1, "subject_id": 1, "class_id": 1, "hours_per_week": 5, "default_cabinet": "101"},
    {"id": 2, "shift_id": 1, "teacher_id": 1, "subject_id": 1, "class_id": 2, "hours_per_week": 5, "default_cabinet": "101"},
    {"id": 3, "shift_id": 1, "teacher_id": 2, "subject_id": 3, "class_id": 1, "hours_per_week": 1, "default_cabinet": "201"},  // Подгруппа 1
    {"id": 4, "shift_id": 1, "teacher_id": 3, "subject_id": 3, "class_id": 1, "hours_per_week": 1, "default_cabinet": "202"}  // Подгруппа 2
]
```

#### Таблица `cabinets` (Кабинеты)
```sql
CREATE TABLE cabinets (
    id INTEGER PRIMARY KEY,
    name VARCHAR(10) NOT NULL UNIQUE,
    subject_id INTEGER REFERENCES subjects(id),
    max_classes_simultaneously INTEGER DEFAULT 1,
    subgroups_only BOOLEAN DEFAULT FALSE,
    exclusive_to_subject BOOLEAN DEFAULT FALSE
);
```

**Пример данных:**
```json
[
    {"id": 1, "name": "101", "subject_id": 1, "max_classes_simultaneously": 1, "subgroups_only": false, "exclusive_to_subject": true},  // Математика, только для математики
    {"id": 2, "name": "201", "subject_id": 3, "max_classes_simultaneously": 1, "subgroups_only": true, "exclusive_to_subject": false},  // Информатика, только для подгрупп
    {"id": 3, "name": "301", "subject_id": null, "max_classes_simultaneously": 2, "subgroups_only": false, "exclusive_to_subject": false}  // Универсальный, 2 класса одновременно
]
```

#### Таблица `cabinet_teachers` (Закрепление кабинетов за учителями)
```sql
CREATE TABLE cabinet_teachers (
    id INTEGER PRIMARY KEY,
    cabinet_id INTEGER NOT NULL REFERENCES cabinets(id),
    teacher_id INTEGER NOT NULL REFERENCES teachers(id),
    UNIQUE(cabinet_id, teacher_id)
);
```

**Пример данных:**
```json
[
    {"id": 1, "cabinet_id": 1, "teacher_id": 1},  // Кабинет 101 закреплен за учителем Ивановым
    {"id": 2, "cabinet_id": 2, "teacher_id": 2}  // Кабинет 201 закреплен за учителем Петровой
]
```

#### Таблица `permanent_schedule` (Постоянное расписание)
```sql
CREATE TABLE permanent_schedule (
    id INTEGER PRIMARY KEY,
    shift_id INTEGER NOT NULL REFERENCES shifts(id),
    day_of_week INTEGER NOT NULL,  -- 1=Понедельник, 7=Воскресенье
    lesson_number INTEGER NOT NULL,  -- Номер урока (1, 2, 3, ...)
    class_id INTEGER NOT NULL REFERENCES classes(id),
    subject_id INTEGER NOT NULL REFERENCES subjects(id),
    teacher_id INTEGER NOT NULL REFERENCES teachers(id),
    cabinet VARCHAR(10) NOT NULL,
    UNIQUE(shift_id, day_of_week, lesson_number, class_id, teacher_id, cabinet)
);
```

**Пример данных:**
```json
[
    {"id": 1, "shift_id": 1, "day_of_week": 1, "lesson_number": 1, "class_id": 1, "subject_id": 1, "teacher_id": 1, "cabinet": "101"},
    {"id": 2, "shift_id": 1, "day_of_week": 1, "lesson_number": 2, "class_id": 1, "subject_id": 1, "teacher_id": 1, "cabinet": "101"},
    {"id": 3, "shift_id": 1, "day_of_week": 1, "lesson_number": 3, "class_id": 1, "subject_id": 3, "teacher_id": 2, "cabinet": "201"},  // Подгруппа 1
    {"id": 4, "shift_id": 1, "day_of_week": 1, "lesson_number": 3, "class_id": 1, "subject_id": 3, "teacher_id": 3, "cabinet": "202"}  // Подгруппа 2 (тот же слот!)
]
```

#### Таблица `schedule_settings` (Настройки расписания)
```sql
CREATE TABLE schedule_settings (
    id INTEGER PRIMARY KEY,
    shift_id INTEGER NOT NULL REFERENCES shifts(id),
    day_of_week INTEGER NOT NULL,  -- 1=Понедельник, 7=Воскресенье
    lessons_count INTEGER NOT NULL DEFAULT 6,  -- Максимум уроков в день
    UNIQUE(shift_id, day_of_week)
);
```

**Пример данных:**
```json
[
    {"id": 1, "shift_id": 1, "day_of_week": 1, "lessons_count": 6},  // Понедельник: 6 уроков
    {"id": 2, "shift_id": 1, "day_of_week": 2, "lessons_count": 6},  // Вторник: 6 уроков
    {"id": 3, "shift_id": 1, "day_of_week": 3, "lessons_count": 6},  // Среда: 6 уроков
    {"id": 4, "shift_id": 1, "day_of_week": 4, "lessons_count": 6},  // Четверг: 6 уроков
    {"id": 5, "shift_id": 1, "day_of_week": 5, "lessons_count": 5}   // Пятница: 5 уроков
]
```

### 3.2. Связи между таблицами

```
shifts (1) ──< (N) shift_classes (N) >── (1) classes
shifts (1) ──< (N) class_load (N) >── (1) classes
shifts (1) ──< (N) class_load (N) >── (1) subjects
shifts (1) ──< (N) teacher_assignments (N) >── (1) teachers
shifts (1) ──< (N) teacher_assignments (N) >── (1) subjects
shifts (1) ──< (N) teacher_assignments (N) >── (1) classes
shifts (1) ──< (N) permanent_schedule (N) >── (1) classes
shifts (1) ──< (N) permanent_schedule (N) >── (1) subjects
shifts (1) ──< (N) permanent_schedule (N) >── (1) teachers
cabinets (1) ──< (N) cabinet_teachers (N) >── (1) teachers
subjects (1) ──< (N) cabinets
```

---

## 4. ПРИМЕР ЗАПРОСА ДЛЯ ГЕНЕРАЦИИ РАСПИСАНИЯ

### 4.1. Структура запроса

```json
{
    "shift_id": 1,
    "filter_settings": {
        "algorithm": "pipeline",
        "lessonMode": "pairs",
        "subgroupPairs": [
            {
                "subject1_id": 3,
                "subject2_id": 3,
                "subject1_name": "Информатика",
                "subject2_name": "Информатика"
            },
            {
                "subject1_id": 3,
                "subject2_id": 4,
                "subject1_name": "Информатика",
                "subject2_name": "Казахский язык"
            }
        ]
    }
}
```

### 4.2. Параметры фильтра

- **algorithm**: `"pipeline"` | `"greedy"` | `"cp_sat"` | `"basic"`
- **lessonMode**: `"pairs"` | `"single"`
- **subgroupPairs**: Массив пар предметов для подгрупп

---

## 5. ПРИМЕР ОТВЕТА ОТ СИСТЕМЫ

### 5.1. Успешная генерация

```json
{
    "success": true,
    "message": "Расписание успешно сгенерировано. Размещено уроков: 45",
    "warnings": [],
    "summary": "Все уроки размещены успешно"
}
```

### 5.2. Частичная генерация с предупреждениями

```json
{
    "success": true,
    "message": "Расписание успешно сгенерировано. Размещено уроков: 42",
    "warnings": [
        "Класс 5А, Математика: не удалось разместить 1 час (нет свободных слотов)",
        "Класс 6Б, Физика: не удалось разместить 2 часа (учитель занят)"
    ],
    "summary": "Размещено 42 из 45 уроков"
}
```

### 5.3. Ошибка генерации

```json
{
    "success": false,
    "error": "Не удалось сгенерировать расписание",
    "warnings": [
        "Недостаточно слотов для размещения всех уроков",
        "Конфликты при размещении: учитель Иванов занят во всех доступных слотах"
    ],
    "summary": "Нет предложений для размещения"
}
```

---

## 6. КРИТЕРИИ УСПЕШНОГО РАСПИСАНИЯ

### 6.1. Обязательные требования

✅ Все уроки размещены (`remaining_hours = 0` для всех требований)
✅ **Нет окон в классах** (обязательное требование)
✅ Минимальное количество окон у учителей
✅ Все ограничения соблюдены

### 6.2. Недопустимые ситуации

❌ Не все уроки размещены
❌ Есть окна в классах (недопустимо)
❌ Нарушены обязательные ограничения

**Определение "окна в классе":**
- Окно = пустой урок между двумя заполненными уроками
- Пример: урок 1 (есть), урок 2 (пусто), урок 3 (есть) = ОКНО ❌

---

## 7. ПРИОРИТЕТЫ РАЗМЕЩЕНИЯ (Soft Constraints)

### 7.1. Приоритет размещения задач

1. **Подгруппы размещаются первыми** (они сложнее)
2. **Больше часов = выше приоритет** (сначала размещаем предметы с большим количеством часов)
3. **Больше учителей = сложнее** (предметы с несколькими учителями размещаются раньше)

### 7.2. Приоритет кабинетов

1. **Приоритет 1 (высший)**: Кабинеты, закрепленные за учителем
2. **Приоритет 2 (средний)**: Кабинеты для этого предмета, но не закрепленные за учителем
3. **Приоритет 3 (низкий)**: Другие кабинеты

### 7.3. Приоритет слотов (день, урок)

- **Заполнение окна между уроками**: приоритет **-1000** (самый высокий)
- **Размещение рядом с существующими уроками**: приоритет **-200**
- **Размещение, которое создаст окно**: приоритет **+100** (низкий, избегаем)

---

## 8. ИСПОЛЬЗОВАНИЕ ДЛЯ СОЗДАНИЯ ПРОМПТА

### 8.1. Основные правила для нейросети

При генерации расписания нейросеть ДОЛЖНА:

1. **Строго соблюдать все ограничения из раздела 1**
2. **Учитывать настройки фильтров из раздела 2**
3. **Использовать структуру БД из раздела 3**
4. **Следовать приоритетам из раздела 7**

### 8.2. Пример промпта для нейросети

```
Ты - система автоматического составления расписания уроков для школы.

СТРОГИЕ ОГРАНИЧЕНИЯ (НЕЛЬЗЯ НАРУШАТЬ):
1. Учитель не может быть в двух классах одновременно в один слот (день + урок)
2. Исключение: подгруппы - несколько учителей одного предмета в одном слоте для одного класса
3. Кабинет не может быть занят более чем max_classes_simultaneously классами одновременно
4. В одном слоте для класса могут быть только уроки с одинаковым предметом (подгруппы)
5. Максимум уроков в день для класса: max_lessons_per_day[day]
6. Должно быть размещено точно total_hours_per_week часов для каждой пары (класс, предмет)

НАСТРОЙКИ ФИЛЬТРА:
- Алгоритм: {algorithm}
- Режим размещения: {lessonMode}
- Пары предметов для подгрупп: {subgroupPairs}

ПРИОРИТЕТЫ:
1. Заполнение окон в классах (самый важный)
2. Размещение подгрупп
3. Группировка параллелей
4. Равномерное распределение

Создай расписание, соблюдая все ограничения и учитывая настройки фильтра.
```

---

## 9. ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### 9.1. Пример 1: Простое расписание без подгрупп

**Входные данные:**
- Класс 5А: Математика (5 часов), Русский язык (4 часа)
- Учитель Иванов: Математика для 5А
- Учитель Петрова: Русский язык для 5А

**Результат:**
```
Понедельник: Математика (урок 1, 2), Русский язык (урок 3, 4)
Вторник: Математика (урок 1, 2), Русский язык (урок 3)
Среда: Математика (урок 1)
```

### 9.2. Пример 2: Расписание с подгруппами

**Входные данные:**
- Класс 5А: Информатика (2 часа, 2 подгруппы)
- Учитель Сидоров: Информатика для 5А (подгруппа 1)
- Учитель Козлов: Информатика для 5А (подгруппа 2)

**Результат:**
```
Понедельник, урок 3:
- Класс 5А: Информатика, Учитель Сидоров (подгруппа 1)
- Класс 5А: Информатика, Учитель Козлов (подгруппа 2)  // Один слот!
```

### 9.3. Пример 3: Расписание с фильтром "строго один предмет в день"

**Входные данные:**
- Класс 5А: Математика (5 часов)
- Фильтр: lessonMode = "single"

**Результат:**
```
Понедельник: Математика (урок 1)
Вторник: Математика (урок 2)
Среда: Математика (урок 3)
Четверг: Математика (урок 4)
Пятница: Математика (урок 5)
```

---

## 10. ЗАМЕТКИ ДЛЯ РАЗРАБОТЧИКОВ

- Все ограничения проверяются перед размещением урока
- Подгруппы обрабатываются специальным образом
- Окна в классах недопустимы и должны быть устранены
- Окна у учителей допускаются, но минимизируются
- Алгоритм не гарантирует оптимальное решение (эвристический подход)

---

**Версия документа:** 1.0
**Дата создания:** 2024
**Автор:** Schedule App Development Team

