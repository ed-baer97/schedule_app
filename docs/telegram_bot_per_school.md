# Отдельный Telegram бот для каждой школы

## Реализовано

### 1. Модель School
- Добавлено поле `telegram_bot_token` (опционально)
- Если токен не указан, используется общий токен из `config.py`

### 2. Функции отправки
- `send_telegram_message()` теперь принимает `school_id` и `bot_token`
- Автоматически определяет токен:
  1. Если передан `bot_token` - использует его
  2. Если передан `school_id` - получает токен из БД школы
  3. Иначе - использует общий токен из конфигурации

### 3. API для настройки
- Маршрут `/super-admin/schools/<school_id>/telegram-token` (POST)
- Позволяет установить или удалить токен для школы

## Как использовать

### Для супер-администратора:

1. **Создать бота для школы:**
   - Открыть @BotFather в Telegram
   - Создать нового бота: `/newbot`
   - Получить токен (формат: `123456789:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`)

2. **Настроить токен в системе:**
   - Перейти в панель супер-администратора
   - Выбрать школу
   - Установить токен через API или добавить в админ-панель

### Для разработчика:

```python
# Установить токен для школы
school = School.query.get(school_id)
school.telegram_bot_token = "123456789:ABC-DEF..."
db.session.commit()

# Или через API
POST /super-admin/schools/1/telegram-token
{
    "telegram_token": "123456789:ABC-DEF..."
}
```

## Преимущества

✅ **Полная изоляция** - каждая школа имеет свой бот
✅ **Собственные rate limits** - 20-30 сообщений/сек для каждой школы
✅ **Независимость** - школы не мешают друг другу
✅ **Обратная совместимость** - если токен не указан, используется общий

## Миграция БД

Для существующих баз данных нужно добавить поле `telegram_bot_token`:

```python
# Выполнить один раз
from app import app, db
from models_system import School

with app.app_context():
    # SQLite автоматически добавит поле при следующем изменении схемы
    # Или можно выполнить вручную через ALTER TABLE
    db.create_all()
```

## Рекомендации

1. **Для каждой школы создавать отдельного бота** - это лучшая практика
2. **Хранить токены безопасно** - не коммитить в репозиторий
3. **Использовать переменные окружения** для общего токена (fallback)

